<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Eternal Brothers FC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: "Cairo", sans-serif;
  background-color: #121212;
  color: #e0e0e0;
  margin:0;
  padding:10px;
  text-align:center;
}
.nav-buttons {
  display:flex;
  justify-content:space-between;
  margin-bottom:20px;
}
button {
  padding:10px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
#homeBtn { background:#d32f2f; color:#fff; }
#blueBtn { background:#1976d2; color:#fff; }
#yellowBtn { background:#fbc02d; color:#000; }

.container {
  display:none;
  max-width:95%;
  margin:auto;
  background:#1e1e1ecc;
  padding:20px 10px;
  border-radius:15px;
  box-shadow:0 0 10px #000;
}
h1,h2,h3 { margin:10px 0; }
input[type=text] { padding:8px; width:80%; border-radius:8px; border:1px solid #555; margin:5px 0; background:#2c2c2c; color:#fff; text-align:center; }
ul { list-style:none; padding:0; margin-top:10px; text-align:left; font-weight:bold; }
li { margin:5px 0; padding:6px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
#teamList li { background:#a8e6a1; color:black; }
#waitingList li { background:#ffe0e0; color:black; }
#blueList li { background:rgba(25,118,210,0.7); color:black; }
#yellowList li { background:rgba(251,192,42,0.7); color:black; }

.action-btn {
  margin-left:6px;
  border:none;
  border-radius:5px;
  padding:4px 8px;
  cursor:pointer;
  font-weight:bold;
}
.edit-btn { background:#4caf50; color:#fff; }
.delete-btn { background:#e53935; color:#fff; }
.player-name-editable { 
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 4px;
    transition: background 0.2s;
}
.player-name-editable:hover {
    background: rgba(255, 255, 255, 0.2);
}

.player-marker { width:35px; height:35px; border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold; position:absolute; cursor:grab; user-select:none; }
.player-name {
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  color: black;
  white-space: nowrap;
  font-weight: bold;
}

.field { width:100%; max-width:400px; height:250px; background:#4CAF50; margin:10px auto; border:2px solid #fff; border-radius:10px; position:relative; touch-action:none; }
.field .center-circle { position:absolute; width:50px;height:50px;border-radius:50%;border:2px solid #fff; top:50%; left:50%; transform:translate(-50%,-50%); }
.field .penalty-box-left, .field .penalty-box-right { position:absolute;width:60px;height:120px;border:2px solid #fff; top:50%; transform:translateY(-50%); }
.field .penalty-box-left { left:0; }
.field .penalty-box-right { right:0; }
.field .mid-line { position:absolute; width:0;height:100%;border-left:2px solid #fff; top:0; left:50%; transform:translateX(-50%); }

#blueFormationSelect { background:#2c2c2c; color:#fff; border:1px solid #555; }
#yellowFormationSelect { background:#2c2c2c; color:#000; border:1px solid #555; }

/* ğŸ†• CHAT STYLES */
.chat-container {
  width: 100%; 
  max-width: 100%; 
  margin: 20px 0 0 0;
  background: #242424;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 0 5px #000;
  text-align: right; /* RTL support for chat elements */
}
.chat-messages {
  height: 250px;
  overflow-y: auto;
  margin-bottom: 10px;
  padding: 5px;
  background: #1e1e1e;
  border-radius: 5px;
  display: flex;
  flex-direction: column; /* â¬…ï¸ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ø³ÙÙ„ */
  text-align: right;
}
.message {
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 10px;
  background: #333;
  word-wrap: break-word;
  max-width: 90%;
  align-self: flex-start; /* Default alignment */
  font-size: 14px;
  line-height: 1.4;
  text-align: right;
}
.my-message {
  background: #d32f2f; /* Red/Maroon for own messages */
  color: #fff;
  align-self: flex-end; /* Align to the left/end for own messages */
  text-align: right;
}
.message-header {
  font-weight: bold;
  font-size: 12px;
  color: #888;
  display: block;
  margin-bottom: 4px;
}
.my-message .message-header {
  color: #f7f7f7;
}
.chat-input-group {
  display: flex;
  gap: 5px;
}
#chatNameInput {
  width: 30%;
  text-align: right;
}
#chatMsgInput {
  flex-grow: 1;
  text-align: right;
}
#sendChatBtn {
  background: #d32f2f;
  color: #fff;
  padding: 8px 15px;
}
</style>
</head>
<body>

<div class="nav-buttons">
  <button id="blueBtn" onclick="showSection('blue')">Blue</button>
  <button id="homeBtn" onclick="showSection('main')">Home</button>
  <button id="yellowBtn" onclick="showSection('yellow')">Yellow</button>
</div>

<div id="main" class="container">
  <h1 style="margin-top:0; font-size:28px; display:flex; align-items:center; justify-content:center; gap:8px;">
    &#10022; <span style="color:#1976d2;">Eternal</span> <span style="color:#fbc02d;">Brothers</span> &#10022;
  </h1>

  <p style="margin:5px 0; font-weight:bold; color:#fb8c00; font-size:16px;">
    The game will be at 9:40 AM
  </p>

  <p id="addressDisplay" style="margin:5px 0; font-weight:bold; cursor:pointer; color:#9c27b0;">
    Click here to set match address
  </p>

  <h2>Add Player</h2>
  <input type="text" id="nameInput" placeholder="Enter player name">
  <button onclick="addPlayer()">Add</button>

  <h2>Main Team (24 max)</h2>
  <ul id="teamList"></ul>

  <h2>Waiting List</h2>
  <ul id="waitingList"></ul>

  <p style="margin-top:15px; font-size:12px; color:#ccc;">
    We might need to change the football field at any time. Please follow the group chat in case of any changes
  </p>
  
  <div class="chat-container">
    <h2>Group Chat</h2>
    <div id="chatMessages" class="chat-messages">
      </div>
    <div class="chat-input-group">
      <input type="text" id="chatNameInput" placeholder="Your Name" value="" style="width: 25%; text-align: right;">
      <input type="text" id="chatMsgInput" placeholder="Write a message..." style="width: 60%; text-align: right;">
      <button id="sendChatBtn" onclick="sendMessage()">Send</button>
    </div>
  </div>
  </div>

<div id="blue" class="container" style="background:#1565c0aa;">
  <h2>Blue Team</h2>
  <input type="text" id="blueInput" placeholder="Enter player name">
  <button onclick="addBlue()">Add</button>
  <ul id="blueList"></ul>
  
  <h3>Plan Management</h3>
  <div style="margin-bottom: 10px;">
    <select id="blueFormationSelect" style="padding: 8px; border-radius: 8px;"></select>
    <button onclick="loadFormation('blue')" style="background:#4CAF50; color:#fff;">Load</button>
    <button onclick="saveFormation('blue')" style="background:#FF9800; color:#fff;">Save</button>
  </div>
  <div id="bluePlan" class="field">
    <div class="mid-line"></div>
    <div class="center-circle"></div>
    <div class="penalty-box-left"></div>
    <div class="penalty-box-right"></div>
  </div>
</div>

<div id="yellow" class="container" style="background:#fdd835aa; color:#000;">
  <h2>Yellow Team</h2>
  <input type="text" id="yellowInput" placeholder="Enter player name">
  <button onclick="addYellow()">Add</button>
  <ul id="yellowList"></ul>

  <h3>Plan Management</h3>
  <div style="margin-bottom: 10px;">
    <select id="yellowFormationSelect" style="padding: 8px; border-radius: 8px;"></select>
    <button onclick="loadFormation('yellow')" style="background:#4CAF50; color:#fff;">Load</button>
    <button onclick="saveFormation('yellow')" style="background:#FF9800; color:#fff;">Save</button>
  </div>
  <div id="yellowPlan" class="field">
    <div class="mid-line"></div>
    <div class="center-circle"></div>
    <div class="penalty-box-left"></div>
    <div class="penalty-box-right"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =========================================================================================
// âš ï¸âš ï¸âš ï¸ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù‡Ù†Ø§ âš ï¸âš ï¸âš ï¸
// =========================================================================================
const supabaseUrl = "https://wihhlvgkjglphjzhivdn.supabase.co"; //  âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø¹Ù†ÙˆØ§Ù† URL Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Supabase
const supabaseServiceKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpaGhsdmdramdscGhqemhpdmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMwOTYsImV4cCI6MjA3ODUxOTA5Nn0.0uG2yhtSzNiGfn3f1ZjB0p33lMh75Et28aMgMGznWlQ"; // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù…ÙØªØ§Ø­ Anon (Public) Key Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Supabase
const supabase = window.supabase.createClient(supabaseUrl, supabaseServiceKey);
// =========================================================================================

const playerPositions = { blue: {}, yellow: {} };
const nameColors = ["#e53935", "#1e88e5", "#fbc02d","#43a047","#8e24aa","#fb8c00","#00acc1","#d81b60","#6d4c41","#3949ab","#f4511e","#7cb342"];

function showSection(id){
  document.querySelectorAll('.container').forEach(c=>c.style.display='none');
  document.getElementById(id).style.display='block';
}
showSection('main');

function isWithinAllowedTime(){
  const now = new Date();
  const day = now.getDay();
  const hour = now.getHours();
  if(day===3 && hour>=15) return true;
  if(day===4 || day===5 || day===6) return true;
  if(day===0 && hour<12) return true;
  return false;
}

// ---- MAIN & WAITING TEAM ----
async function addPlayer(){
  if(!isWithinAllowedTime()){
    return alert("Adding players is only allowed from Wednesday 3 PM to Sunday 12 PM.");
  }
  const name = document.getElementById("nameInput").value.trim();
  if(!name) return alert("Enter a name");
  const { data: team } = await supabase.from("main_team").select("id");
  if(team.length < 24){
    const { error } = await supabase.from("main_team").insert([{name,time:Date.now()}]);
    if(error) return alert(error.message);
  } else {
    const { error } = await supabase.from("waiting_list").insert([{name,time:Date.now()}]);
    if(error) return alert(error.message);
    alert("Main team is full (24). Player added to waiting list.");
  }
  document.getElementById("nameInput").value="";
  loadPlayers();
}

async function loadPlayers(){
  try {
    const { data: team } = await supabase.from("main_team").select("*").order("id");
    const { data: waiting } = await supabase.from("waiting_list").select("*").order("id");
    const teamList = document.getElementById("teamList");
    const waitingList = document.getElementById("waitingList");
    teamList.innerHTML = "";
    waitingList.innerHTML = "";

    if(team) team.forEach((p,i) => {
      // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… span Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
      const nameSpan = `<span class="player-name-editable" data-table="main_team" data-id="${p.id}" data-name="${p.name}">${p.name}</span>`;
      
      teamList.innerHTML += `
        <li>${i+1}. ${nameSpan}
          <span>
            <button class="action-btn delete-btn" onclick="deletePlayer('main_team',${p.id})">&#128465;</button>
          </span>
        </li>`;
    });

    if(waiting) waiting.forEach((p,i) => {
      // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… span Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
      const nameSpan = `<span class="player-name-editable" data-table="waiting_list" data-id="${p.id}" data-name="${p.name}">${p.name}</span>`;

      waitingList.innerHTML += `
        <li>${i+1}. ${nameSpan}
          <span>
            <button class="action-btn delete-btn" onclick="deletePlayer('waiting_list',${p.id})">&#128465;</button>
          </span>
        </li>`;
    });
    
    setupEditListener(); // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
  } catch(err){ console.error(err); }
}

async function refillMainTeam(){
  const { data: team } = await supabase.from("main_team").select("id");
  const { data: waiting } = await supabase.from("waiting_list").select("*").order("id");
  if(team.length < 24 && waiting.length > 0){
    const first = waiting[0];
    await supabase.from("main_team").insert([{ name:first.name, time:Date.now() }]);
    await supabase.from("waiting_list").delete().eq("id", first.id);
  }
  loadPlayers();
}

// ---- BLUE TEAM ----
async function addBlue(){
  const name=document.getElementById("blueInput").value.trim();
  if(!name) return;
  const { data: team } = await supabase.from("blue_team").select("id");
  if(team.length >= 12) return alert("Blue team is full (12 players).");
  await supabase.from("blue_team").insert([{name,time:Date.now()}]);
  document.getElementById("blueInput").value="";
  loadBlue();
}

async function loadBlue(){
  const { data } = await supabase.from("blue_team").select("*").order("id");
  const ul=document.getElementById("blueList");
  const field=document.getElementById("bluePlan");
  ul.innerHTML=""; field.innerHTML=`<div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>`;
  if(data) data.forEach((p,i)=>{
    // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… span Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    const nameSpan = `<span class="player-name-editable" data-table="blue_team" data-id="${p.id}" data-name="${p.name}">${p.name}</span>`;

    ul.innerHTML += `
      <li>${i+1}. ${nameSpan}
        <span>
          <button class="action-btn delete-btn" onclick="deletePlayer('blue_team',${p.id})">&#128465;</button>
        </span>
      </li>`;
    // We no longer use individual player positions in the DB for initial load, 
    // positions are managed by the Formation system now.
    createPlayerMarker('blue', p.name, i+1); 
  });
  setupEditListener(); // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
}

// ---- YELLOW TEAM ----
async function addYellow(){
  const name=document.getElementById("yellowInput").value.trim();
  if(!name) return;
  const { data: team } = await supabase.from("yellow_team").select("id");
  if(team.length >= 12) return alert("Yellow team is full (12 players).");
  await supabase.from("yellow_team").insert([{name,time:Date.now()}]);
  document.getElementById("yellowInput").value="";
  loadYellow();
}

async function loadYellow(){
  const { data } = await supabase.from("yellow_team").select("*").order("id");
  const ul=document.getElementById("yellowList");
  const field=document.getElementById("yellowPlan");
  ul.innerHTML=""; field.innerHTML=`<div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>`;
  if(data) data.forEach((p,i)=>{
    // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… span Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    const nameSpan = `<span class="player-name-editable" data-table="yellow_team" data-id="${p.id}" data-name="${p.name}">${p.name}</span>`;

    ul.innerHTML += `
      <li>${i+1}. ${nameSpan}
        <span>
          <button class="action-btn delete-btn" onclick="deletePlayer('yellow_team',${p.id})">&#128465;</button>
        </span>
      </li>`;
    // We no longer use individual player positions in the DB for initial load, 
    // positions are managed by the Formation system now.
    createPlayerMarker('yellow', p.name, i+1); 
  });
  setupEditListener(); // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
}

// ---- EDIT & DELETE (ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© editPlayer Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ----
async function deletePlayer(table,id){
  if(!confirm("Are you sure you want to delete this player?")) return;
  await supabase.from(table).delete().eq("id",id);
  if(table==="main_team") await refillMainTeam();
  reloadList(table);
}

async function editPlayer(table,id,oldName){
  const newName=prompt("Edit name:", oldName);
  if(!newName || newName.trim()==="") return;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const { error } = await supabase.from(table).update({name:newName.trim()}).eq('id',id);
  if(error) return alert(error.message);

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
  reloadList(table);
}

function reloadList(table){
  if(table==="main_team" || table==="waiting_list") loadPlayers();
  else if(table==="blue_team") loadBlue();
  else if(table==="yellow_team") loadYellow();
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªÙØ¹ÙŠÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
function setupEditListener() {
  document.querySelectorAll('.player-name-editable').forEach(span => {
    span.addEventListener('dblclick', function() {
      const table = this.getAttribute('data-table');
      const id = parseInt(this.getAttribute('data-id'));
      const oldName = this.getAttribute('data-name');
      
      editPlayer(table, id, oldName);
    });
  });
}

// ---- PLAYER MARKERS (Updated to use playerPositions object) ----
function createPlayerMarker(team, playerName, playerIndex) {
  const fieldId = team === 'blue' ? 'bluePlan' : 'yellowPlan';
  const field = document.getElementById(fieldId);

  const marker = document.createElement('div');
  marker.classList.add('player-marker');
  marker.style.background = team==='blue'? '#1976d2' : '#fbc02d';
  marker.innerText = playerIndex;

  // Set initial position (or existing position if already dragged)
  let pos = playerPositions[team][playerName] || { 
    left: '10px', 
    top: `${30 + playerIndex * 30}px` 
  };
  marker.style.left = pos.left;
  marker.style.top = pos.top;
  playerPositions[team][playerName] = pos; // Ensure it's tracked in the object

  const label = document.createElement('div');
  label.classList.add('player-name');
  label.innerText = playerName;
  label.style.color = 'black';
  marker.appendChild(label);

  let isDragging=false, offsetX, offsetY;

  function startDrag(e){
    isDragging=true;
    const rect=marker.getBoundingClientRect();
    if(e.type.startsWith('touch')){
      const touch=e.touches[0];
      offsetX=touch.clientX - rect.left;
      offsetY=touch.clientY - rect.top;
    } else {
      offsetX=e.offsetX;
      offsetY=e.offsetY;
    }
  }

  function moveDrag(e){
    if(!isDragging) return;
    e.preventDefault(); // Prevent scrolling on mobile during drag
    const rect=field.getBoundingClientRect();
    let clientX, clientY;
    if(e.type.startsWith('touch')){
      const touch=e.touches[0];
      clientX=touch.clientX;
      clientY=touch.clientY;
    } else {
      clientX=e.clientX;
      clientY=e.clientY;
    }
    
    // Calculate new position relative to the field
    let newLeft = clientX - rect.left - offsetX;
    let newTop = clientY - rect.top - offsetY;

    // Boundary checks (keep marker inside field)
    newLeft = Math.max(0, Math.min(newLeft, rect.width - marker.offsetWidth));
    newTop = Math.max(0, Math.min(newTop, rect.height - marker.offsetHeight));

    marker.style.left = `${newLeft}px`;
    marker.style.top = `${newTop}px`;
  }

  function endDrag(){
    if(!isDragging) return;
    isDragging=false;
    // Update the position in the local playerPositions object (will be saved later by saveFormation)
    playerPositions[team][playerName] = { 
      left: marker.style.left, 
      top: marker.style.top 
    };
    // Note: The previous code was updating the player's individual DB entry on endDrag,
    // which is now replaced by the 'saveFormation' logic.
  }

  marker.addEventListener('mousedown', startDrag);
  marker.addEventListener('touchstart', startDrag);
  document.addEventListener('mousemove', moveDrag);
  document.addEventListener('touchmove', moveDrag);
  document.addEventListener('mouseup', endDrag);
  document.addEventListener('touchend', endDrag);

  field.appendChild(marker);
}

// ----------------------------------------------------------------------
// ---- NEW FORMATION MANAGEMENT FUNCTIONS --------------------------------
// ----------------------------------------------------------------------

// Function to load formation names into the dropdown
async function loadFormationNames(team) {
  const select = document.getElementById(`${team}FormationSelect`);
  select.innerHTML = '<option value="">-- Select Formation --</option>'; 

  const { data, error } = await supabase
    .from('formations')
    .select('name')
    .eq('team_color', team)
    .order('name');

  if (error) {
    console.error(`Error loading ${team} formations:`, error);
    return;
  }

  data.forEach(f => {
    const option = document.createElement('option');
    option.value = f.name;
    option.textContent = f.name;
    select.appendChild(option);
  });
}

// Function to save the current player positions as a new formation
async function saveFormation(team) {
  const formationName = prompt("Enter a name for this formation (e.g., 4-4-2):");
  if (!formationName || formationName.trim() === "") return alert("Formation name cannot be empty.");

  const playerPositionsData = {};
  const fieldId = team === 'blue' ? 'bluePlan' : 'yellowPlan';
  const field = document.getElementById(fieldId);
  
  // 1. Collect current positions from the local playerPositions object
  // (This ensures we get the latest position even if markers were not moved recently)
  Object.keys(playerPositions[team]).forEach(playerName => {
    playerPositionsData[playerName] = playerPositions[team][playerName];
  });
  
  if (Object.keys(playerPositionsData).length === 0) {
    return alert(`Please add players to the ${team} team first.`);
  }

  // 2. Check if a formation with this name already exists
  const { data: existing } = await supabase
    .from('formations')
    .select('id')
    .eq('team_color', team)
    .eq('name', formationName.trim())
    .limit(1);

  if (existing.length > 0) {
    // Update existing formation
    const { error } = await supabase
      .from('formations')
      .update({ positions_json: playerPositionsData })
      .eq('id', existing[0].id);

    if (error) return alert(`Error updating formation: ${error.message}`);
    alert(`Formation "${formationName.trim()}" updated successfully!`);
  } else {
    // Insert new formation
    const { error } = await supabase.from('formations').insert([{
      team_color: team,
      name: formationName.trim(),
      positions_json: playerPositionsData
    }]);

    if (error) return alert(`Error saving formation: ${error.message}`);
    alert(`Formation "${formationName.trim()}" saved successfully!`);
  }
  
  loadFormationNames(team); // Refresh the list
}

// Function to load a saved formation onto the field
async function loadFormation(team) {
  const select = document.getElementById(`${team}FormationSelect`);
  const formationName = select.value;
  if (!formationName) return alert("Please select a formation to load.");

  const { data, error } = await supabase
    .from('formations')
    .select('positions_json')
    .eq('team_color', team)
    .eq('name', formationName)
    .limit(1);

  if (error || data.length === 0) return alert("Error loading formation data.");
  
  const positions = data[0].positions_json;
  const fieldId = team === 'blue' ? 'bluePlan' : 'yellowPlan';
  const field = document.getElementById(fieldId);

  // 1. Update player markers' positions and the local tracking object
  field.querySelectorAll('.player-marker').forEach(marker => {
    const playerName = marker.querySelector('.player-name').innerText;
    
    if (positions[playerName]) {
      marker.style.left = positions[playerName].left;
      marker.style.top = positions[playerName].top;
      
      // Update the global playerPositions object for future saving/editing
      playerPositions[team][playerName] = positions[playerName];
    } else {
      // If player is not in this formation data, move them off-field or to a default bench position
      marker.style.left = '5px'; 
      marker.style.top = '5px'; 
      playerPositions[team][playerName] = { left: '5px', top: '5px' }; // Update local state
    }
  });
  
  alert(`Formation "${formationName}" loaded.`);
}

// ----------------------------------------------------------------------
// ---- MATCH ADDRESS & INITIAL LOAD (Ø§Ù„Ù…ÙØ¹Ø¯Ù‘Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø³ Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø¨Ø¹ Ø£Ø¨ÙŠØ¶) ---
// ----------------------------------------------------------------------

async function loadAddress() {
  try {
    // 1. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ù†ØµØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    let addressDisplayElem = document.getElementById('addressDisplay');
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡ (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§ ÙŠÙØ´Ù„)
    if (!addressDisplayElem) {
        addressDisplayElem = document.createElement('p');
        // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø¥Ø¶Ø§ÙØªÙ‡
        document.querySelector('#main').insertBefore(addressDisplayElem, document.querySelector('#main h2')); 
        addressDisplayElem.id = "addressDisplay";
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø­Ø¯Ø« (Listeners) Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const oldListener = addressDisplayElem.listener;
    if (oldListener) {
        addressDisplayElem.removeEventListener('dblclick', oldListener);
    }

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Supabase
    const { data, error } = await supabase.from('match_info').select('id, match_info').limit(1);
    if(error) throw error;

    const currentAddress = (data && data.length > 0) ? data[0].match_info : null;
    addressDisplayElem.textContent = currentAddress || "Click here to set match address";
    addressDisplayElem.style.margin = "5px 0";
    addressDisplayElem.style.fontWeight = "bold";
    addressDisplayElem.style.cursor = "pointer";
    addressDisplayElem.style.color = "#9c27b0";
    
    // 3. ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸
    const saveAddress = async (input, p) => {
        const val = input.value.trim();
        p.textContent = val === "" ? "Click here to set match address" : val;
        
        // ØªØ¨Ø¯ÙŠÙ„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø¹Ù†ØµØ± Ø§Ù„Ù†Øµ
        input.replaceWith(p);
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        p.addEventListener('dblclick', dblclick_handler);
        p.listener = dblclick_handler; // Ø­ÙØ¸ Ø§Ù„Ù€ listener Ø§Ù„Ø¬Ø¯ÙŠØ¯

        // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        try {
            const { data: existing } = await supabase.from('match_info').select('id').limit(1);

            if(existing && existing.length > 0){
                await supabase.from('match_info').update({ match_info: val }).eq('id', existing[0].id);
            } else {
                await supabase.from('match_info').insert([{ match_info: val }]);
            }
        } catch(err){
            console.error("Error saving match_info:", err);
            // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ØŒ ÙŠØ¸Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¸Ø§Ù‡Ø±Ù‹Ø§ØŒ Ù„ÙƒÙ† Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            alert("Failed to save address to database.");
        }
    };
    
    // 4. ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ (Double-click Handler)
    const dblclick_handler = function() {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù…Ù† Ø¹Ù†ØµØ± Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        this.removeEventListener('dblclick', dblclick_handler);

        const currentText = this.textContent.includes("Click here") ? "" : this.textContent;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentText;
        
        // ØªØ·Ø¨ÙŠÙ‚ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù„ØªØ¨Ø¯Ùˆ Ø´ÙØ§ÙØ© ÙˆÙ…Ù†Ø¯Ù…Ø¬Ø© (Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø¨ÙŠØ¶)
        input.style.width = "80%";
        input.style.padding = "5px";
        input.style.borderRadius = "8px";
        input.style.border = "1px solid #9c27b0"; 
        input.style.background = "transparent"; 
        input.style.color = "#e0e0e0"; 
        input.style.textAlign = "center";
        input.style.fontWeight = "bold";
        input.style.fontSize = "16px"; 
        
        // Ø­ÙØ¸ Ø¹Ù†ØµØ± Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§
        const originalP = this;

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Øµ Ø¨Ù€ input
        this.replaceWith(input);
        input.focus();
        
        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Blur: Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø±Ø¨Ø¹, Enter: Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter)
        input.addEventListener('blur', () => saveAddress(input, originalP));
        input.addEventListener('keypress', e => { 
            if(e.key === 'Enter') {
                input.removeEventListener('blur', arguments.callee); // Ù…Ù†Ø¹ Ø¥Ø·Ù„Ø§Ù‚ blur Ø¨Ø¹Ø¯ Enter
                saveAddress(input, originalP);
            }
        });
    };

    // 5. Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¨Ø¹Ù†ØµØ± Ø§Ù„Ø¹Ø±Ø¶
    addressDisplayElem.addEventListener('dblclick', dblclick_handler);
    // Ø­ÙØ¸ Ø§Ù„Ù€ listener Ù„ØªÙ…ÙƒÙŠÙ† Ø¥Ø²Ø§Ù„ØªÙ‡ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
    addressDisplayElem.listener = dblclick_handler;
    
  } catch(err){
    console.error("Error loading match_info:", err);
    document.getElementById('addressDisplay').textContent = "Error loading address";
  }
}

// ----------------------------------------------------------------------
// ---- ğŸ†• CHAT FUNCTIONS (ØªØ¹Ø¯ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶) ---------------------------
// ----------------------------------------------------------------------

function renderMessage(message) {
  const messagesContainer = document.getElementById('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message');
  
  const storedName = localStorage.getItem('chat_username');
  if (storedName && storedName.trim() === message.username.trim()) {
    msgDiv.classList.add('my-message');
  }

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… 'en-US' Ù„ÙØ±Ø¶ ØªÙ†Ø³ÙŠÙ‚ AM/PM ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØºØ±Ø¨ÙŠØ©
  const date = new Date(message.created_at).toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true, 
    numberingSystem: 'latn' 
  });

  msgDiv.innerHTML = `
    <span class="message-header" dir="rtl">${message.username} <span dir="ltr">${date}</span></span>
    <span dir="rtl">${message.content}</span>
  `;
  
  // â¬…ï¸ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
  messagesContainer.appendChild(msgDiv); 
  // ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  messagesContainer.scrollTop = messagesContainer.scrollHeight; 
}

async function loadChatMessages() {
  const { data, error } = await supabase
    .from('chat_messages')
    .select('*')
    .order('created_at', { ascending: true }) // â¬…ï¸ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªØµØ§Ø¹Ø¯ÙŠ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)
    .limit(50); // Load latest 50 messages

  if (error) {
    console.error('Error loading chat messages:', error);
    return;
  }

  const messagesContainer = document.getElementById('chatMessages');
  messagesContainer.innerHTML = ''; 
  data.forEach(renderMessage);
  
  // ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  messagesContainer.scrollTop = messagesContainer.scrollHeight; 
}

async function sendMessage() {
  const nameInput = document.getElementById('chatNameInput');
  const msgInput = document.getElementById('chatMsgInput');
  
  const username = nameInput.value.trim();
  const content = msgInput.value.trim();

  if (!username) {
    return alert("Please enter your name.");
  }
  if (!content) {
    return alert("Message cannot be empty.");
  }

  // Save name to local storage
  localStorage.setItem('chat_username', username);

  // Insert message into Supabase
  const { error } = await supabase
    .from('chat_messages')
    .insert([{ username, content }]); 

  if (error) {
    console.error('Error sending message:', error);
    return alert(`Error sending message: ${error.message}`);
  }

  msgInput.value = ''; // Clear the message input
}

// Function to handle Realtime updates
function setupRealtimeChat() {
  const channel = supabase
    .channel('chat-room-updates')
    .on(
      'postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'chat_messages' },
      (payload) => {
        // payload.new contains the new message data
        renderMessage(payload.new);
      }
    )
    .subscribe();
}

// ----------------------------------------------------------------------
// ---- INITIAL LOAD & SETUP ----------------------------------------------
// ----------------------------------------------------------------------

// Load username from local storage if available
const storedUsername = localStorage.getItem('chat_username');
if (storedUsername) {
  document.getElementById('chatNameInput').value = storedUsername;
}

// Add event listener for sending message with Enter key
document.getElementById('chatMsgInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

loadPlayers(); 
loadBlue(); 
loadYellow(); 
loadAddress();

loadFormationNames('blue');
loadFormationNames('yellow');

// ğŸ†• Load initial chat messages and set up Realtime
loadChatMessages();
setupRealtimeChat();

</script>
</body>
</html>
